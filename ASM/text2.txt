text db "global main
extern system
extern fopen
extern fprintf
extern fclose

%%macro OPEN_FILE 2
lea rdi, [rel %%1]
lea rsi, [rel %%2]
call fopen wrt ..plt
mov rbx, rax
%%endmacro

%%macro WRITE_CHAR 0
mov al, [rel start]
add al, '0'
movzx rdx, al
lea rsi, [rel format_char]
mov rdi, rbx
xor eax, eax
call fprintf wrt ..plt
%%endmacro

%%macro WRITE_TEXT 3
mov rdi, rbx
lea rsi, [rel %%1]
mov edx, %%2
mov ecx, %%3
lea r8, [rel %%1]
xor eax, eax
call fprintf wrt ..plt
%%endmacro

%%macro FILL 2
lea rbx, [rel %%1]
lea rcx, [rel %%2]
mov dl, [rel start]
add dl, 48
mov rsi, rcx
mov rdi, rbx
%%%%copy_loop:
mov al, [rcx]
cmp al, 'X'
jne %%%%copy_normal
mov al, dl
%%%%copy_normal:
mov [rbx], al
cmp byte [rcx], 0
je %%%%done
inc rcx
inc rbx
jmp %%%%copy_loop
%%%%done:
mov byte [rbx], 0
%%endmacro

section .text
main:
FILL compile_bss, compile_data
FILL run_bss, run_data
FILL filename_bss, filename_data
FILL chmod_bss, chmod_data
sub rsp, 8
OPEN_FILE filename_bss, mode
test rbx, rbx
je .done
WRITE_TEXT text, 10, 34
WRITE_CHAR
cmp eax, 0
jl .done
mov rdi, rbx
call fclose wrt ..plt
mov al, [rel filename_bss + 6]
cmp al, 0
je .done
lea rdi, [rel compile_bss]
call system wrt ..plt
test eax, eax
je .done
lea rdi, [rel chmod_bss]
call system wrt ..plt
lea rdi, [rel run_bss]
call system wrt ..plt
.done:
add rsp, 8
ret

section .bss
filename_bss resb 10
compile_bss resb 65
run_bss resb 10
chmod_bss resb 18

section .data
mode db %2$cw%2$c,0
filename_data db %2$cSully_X.s%2$c,0
compile_data db %2$cnasm -f elf64 Sully_X.s -o Sully_X.o && gcc Sully_X.o -o Sully_X%2$c,0
run_data db %2$c./Sully_X%2$c,0
chmod_data db %2$cchmod 777 Sully_X%2$c,0
text db %2$c%3$s%2$c,0
format_char db %2$c%%c%2$c,0
start db ",0